<!DOCTYPE html>   
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>US Lifestyle Clubs & Dungeons Map</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* (Your original CSS unchanged — copied exactly) */
* {
    box-sizing: border-box;
}
html, body { 
    height: 100%; 
    margin: 0; 
    padding: 0; 
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
body { 
    display: flex; 
    flex-direction: column; 
}
/* --- rest of your CSS is unchanged --- */
</style>
</head>
<body>
<div id="searchForm">
    <div class="input-group">
        <input type="text" id="zipInput" placeholder="Enter ZIP code" maxlength="5" pattern="[0-9]{5}">
        <input type="number" id="radiusInput" placeholder="Miles" min="1" max="500" value="50" title="Search radius in miles">
    </div>
    <div class="button-group">
        <button id="searchBtn">Search Nearby</button>
        <button id="geoBtn">Use My Location</button>
        <button id="resetBtn">Reset Search</button>
    </div>
    <div class="input-group radio-group">
        <label><input type="radio" name="filterType" value="all" checked> Clubs & Dungeons</label>
        <label><input type="radio" name="filterType" value="clubs"> Just Clubs</label>
        <label><input type="radio" name="filterType" value="dungeons"> Just Dungeons</label>
    </div>
    <div id="statusMessage"></div>
</div>
<div id="map"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
// --- Map setup ---
const isMobile = window.matchMedia("(max-width: 768px)").matches;
const defaultCenter = [39.8283, -98.5795];
const defaultZoom = isMobile ? 3 : 4;

const map = L.map('map', { minZoom: 3, maxZoom: 18, zoomControl: false, attributionControl: false })
    .setView(defaultCenter, defaultZoom);

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
    subdomains: 'abcd',
    maxZoom: 19
}).addTo(map);

// Create panes for correct z-index
map.createPane('radiusPane');
map.getPane('radiusPane').style.zIndex = 650;

map.createPane('searchMarkersPane');
map.getPane('searchMarkersPane').style.zIndex = 700;

// Reset button
const ResetControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-control-reset');
        container.innerHTML = 'Reset View';
        L.DomEvent.on(container, 'click', e => { L.DomEvent.stopPropagation(e); resetSearch(); });
        return container;
    }
});
map.addControl(new ResetControl());
L.control.zoom({ position: 'topleft' }).addTo(map);

// Globals
let searchMarkers = [];
let userLocationMarker = null;
let radiusCircle = null;

// --- Fixed search results display ---
function displaySearchResults(venues, zipCoords, radius, zipCode) {
    // Clear old markers
    searchMarkers.forEach(marker => map.removeLayer(marker));
    searchMarkers = [];

    // ✅ FIX: use circleMarker instead of default marker so it doesn’t drift on zoom
    const zipMarker = L.circleMarker([zipCoords.lat, zipCoords.lng], {
        radius: 8,
        color: '#e74c3c',
        fillColor: '#e74c3c',
        fillOpacity: 1,
        weight: 1.2,
        pane: 'searchMarkersPane'
    }).bindPopup(`
        <strong>Search Center</strong><br>
        ${zipCode}<br>
        ${zipCoords.city}, ${zipCoords.state}<br>
        Radius: ${radius} miles
    `).addTo(map);
    searchMarkers.push(zipMarker);

    // Radius circle
    radiusCircle = L.circle([zipCoords.lat, zipCoords.lng], {
        radius: radius * 1609.34,
        fillColor: '#f8f9fa',
        fillOpacity: 0.3,
        color: '#dee2e6',
        weight: 2,
        pane: 'radiusPane'
    }).addTo(map);
    searchMarkers.push(radiusCircle);

    // Venue markers
    venues.forEach(v => {
        const marker = L.marker([v.lat, v.lng], { pane: 'searchMarkersPane' })
            .bindPopup(`<strong>${v.name}</strong><br>${v.city}, ${v.state}`)
            .addTo(map);
        searchMarkers.push(marker);
    });

    // Fit view
    if (venues.length > 0) {
        const group = new L.featureGroup(searchMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
    } else {
        map.setView([zipCoords.lat, zipCoords.lng], 10);
    }
}

// --- Reset function ---
function resetSearch() {
    searchMarkers.forEach(m => map.removeLayer(m));
    searchMarkers = [];
    if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
        userLocationMarker = null;
    }
    if (radiusCircle) {
        map.removeLayer(radiusCircle);
        radiusCircle = null;
    }
    document.getElementById('zipInput').value = '';
    document.getElementById('radiusInput').value = '50';
    map.setView(defaultCenter, defaultZoom);
}
</script>
</body>
</html>
