<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>US Lifestyle Clubs Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  body { display: flex; flex-direction: column; }
  #searchForm {
    flex: 0 0 auto;
    padding: 15px;
    background: #2c3e50;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
  }
  #searchForm input { 
    padding: 12px; 
    border: 1px solid #ddd; 
    border-radius: 6px; 
    font-size: 16px;
    min-width: 180px;
  }
  #searchForm button { 
    padding: 12px 20px; 
    background: #3498db; 
    color: white; 
    border: none; 
    border-radius: 6px; 
    cursor: pointer;
    transition: background 0.2s;
    font-size: 16px;
    font-weight: 500;
  }
  #searchForm button:hover { background: #2980b9; }
  #searchForm button#geoBtn {
    background: #27ae60;
  }
  #searchForm button#geoBtn:hover { background: #219653; }
  #map { flex: 1 1 auto; width: 100%; }
  .leaflet-control-reset {
    background: white;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    border: 2px solid rgba(0,0,0,0.2);
    margin-bottom: 5px;
  }
  .leaflet-control-reset:hover { background: #f8f8f8; }
  .state-label {
    font-weight: bold;
    color: #2c3e50;
    pointer-events: none;
    text-align: center;
    white-space: nowrap;
    z-index: 1000;
    text-shadow: none;
  }
  .state-label.highlight { color: #e74c3c; font-weight: 900; }
  .leaflet-popup-content-wrapper {
    border-radius: 8px;
    padding: 5px;
    background: #f8f9fa;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  }
  .leaflet-popup-content { margin: 18px; font-size: 18px; line-height: 1.5; min-width: 250px; }
  .state-popup-title {
    font-size: 22px;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #3498db;
    text-align: center;
  }
  .club-list { list-style-type: none; padding: 0; margin: 0; }
  .club-item { padding: 12px 0; border-bottom: 1px solid #e0e0e0; }
  .club-item:last-child { border-bottom: none; }
  .club-link { color: #2980b9; text-decoration: none; font-weight: 500; display: block; padding: 8px 12px; border-radius: 4px; transition: background 0.2s; }
  .club-link:hover { background: #e8f4fd; color: #e74c3c; }
  .no-clubs { font-style: italic; color: #7f8c8d; text-align: center; padding: 15px 0; font-size: 16px; }
  .leaflet-control-attribution { display: none !important; }

  @media (max-width: 768px) {
    #searchForm { flex-direction: column; align-items: stretch; }
    #searchForm input { min-width: auto; }
    .state-label { font-size: 10px; }
    .leaflet-popup-content { font-size: 16px; min-width: 200px; }
    .state-popup-title { font-size: 20px; }
  }
</style>
</head>
<body>

<div id="searchForm">
  <input type="text" id="zipInput" placeholder="Enter ZIP code">
  <input type="number" id="radiusInput" placeholder="Radius (miles)" min="1" value="50">
  <button id="searchBtn">Search Nearby Clubs</button>
  <button id="geoBtn">Use My Location</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const isMobile = window.matchMedia("(max-width: 768px)").matches;
const defaultCenter = [39.8283, -98.5795]; 
const defaultZoom = isMobile ? 3 : 4; 

const map = L.map('map', { minZoom: 3, maxZoom: 18, zoomControl: false, attributionControl: false })
  .setView(defaultCenter, defaultZoom);

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
  subdomains: 'abcd', maxZoom: 19
}).addTo(map);

const ResetControl = L.Control.extend({
  options: { position: 'topleft' },
  onAdd: function(map) {
    const container = L.DomUtil.create('div', 'leaflet-control-reset');
    container.innerHTML = 'Reset View';
    L.DomEvent.on(container, 'click', e => {
      L.DomEvent.stopPropagation(e);
      map.setView(defaultCenter, defaultZoom);
    });
    return container;
  }
});
map.addControl(new ResetControl());
L.control.zoom({ position: 'topleft' }).addTo(map);

let clubsByState = {};
let geojsonLayer;
let stateLabels = {};

// Add your stateCentroids, stateAreas, labelAdjustments exactly as in your previous code

// Load clubs.json from same folder
fetch('clubs.json')
  .then(res => res.json())
  .then(data => {
    clubsByState = data;
    return fetch("https://rawcdn.githack.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json");
  })
  .then(res => res.json())
  .then(statesData => {
    geojsonLayer = L.geoJson(statesData, { style, onEachFeature }).addTo(map);
    addStateLabels();
    updateLabelSizes();
  })
  .catch(err => console.error("Error loading data:", err));

function style(feature) {
  const stateName = feature.properties.name === 'District of Columbia' ? 'DC' : feature.properties.name;
  const hasClubs = clubsByState[stateName] && clubsByState[stateName].length > 0;
  return { fillColor: hasClubs ? "#3498db" : "#bdc3c7", weight: 2, color: "white", dashArray: "3", fillOpacity: 0.7 };
}

function highlightFeature(e) {
  const layer = e.target;
  layer.setStyle({ weight: 3, color: "#666", dashArray: "", fillOpacity: 0.9 });
  layer.bringToFront();
  const stateName = layer.feature.properties.name === 'District of Columbia' ? 'DC' : layer.feature.properties.name;
  if (stateLabels[stateName]) stateLabels[stateName].getElement().classList.add('highlight');
}

function resetHighlight(e) {
  geojsonLayer.resetStyle(e.target);
  const stateName = e.target.feature.properties.name === 'District of Columbia' ? 'DC' : e.target.feature.properties.name;
  if (stateLabels[stateName]) stateLabels[stateName].getElement().classList.remove('highlight');
}

function onEachFeature(feature, layer) {
  const stateName = feature.properties.name === 'District of Columbia' ? 'DC' : feature.properties.name;
  const clubs = clubsByState[stateName] || [];
  let popupContent = `<div class="state-popup-title">${stateName}</div>`;
  if (clubs.length === 0) popupContent += `<div class="no-clubs">No clubs listed yet</div>`;
  else {
    popupContent += `<ul class="club-list">`;
    clubs.forEach(club => {
      popupContent += `<li class="club-item">${club.url ? `<a class="club-link" href="${club.url}" target="_blank">${club.name}</a>` : `<span>${club.name}</span>`}</li>`;
    });
    popupContent += `</ul>`;
  }
  layer.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: () => layer.bindPopup(popupContent, { maxWidth: 350 }).openPopup() });
}

function addStateLabels() {
  Object.entries(stateCentroids).forEach(([stateName, coords]) => {
    const adj = labelAdjustments[stateName] || [0,0];
    const label = L.marker([coords[0]+adj[0], coords[1]+adj[1]], {
      icon: L.divIcon({ className: 'state-label', html: stateName, iconSize: [0,0], iconAnchor: [0,0] }),
      interactive: false
    }).addTo(map);
    stateLabels[stateName] = label;
  });
}

function updateLabelSizes() {
  const zoom = map.getZoom();
  const isMobileNow = window.matchMedia("(max-width: 768px)").matches;
  Object.entries(stateLabels).forEach(([stateName, label]) => {
    const el = label.getElement();
    if (zoom <= (isMobileNow ? 3 : 4)) el.style.display = 'none';
    else {
      el.style.display = 'block';
      let baseSize = (zoom === (isMobileNow ? 4 : 5)) ? 10 : (zoom === (isMobileNow ? 5 : 6)) ? 14 : (zoom === (isMobileNow ? 6 : 7)) ? 18 : (zoom === (isMobileNow ? 7 : 8)) ? 22 : 26;
      const area = stateAreas[stateName] || 25000;
      let fontSize = Math.max(8, Math.min(30, baseSize + Math.log(area)/20));
      if (area < 10000) fontSize = Math.max(8, fontSize-2);
      if (area < 5000) fontSize = Math.max(8, fontSize-1);
      el.style.fontSize = fontSize + 'px';
    }
  });
}

document.getElementById('searchBtn').addEventListener('click', () => {
  const zipCode = document.getElementById('zipInput').value;
  if (!zipCode) return alert('Please enter a ZIP code to search.');
  alert(`Search functionality for ZIP code ${zipCode} would be implemented here.`);
});

document.getElementById('geoBtn').addEventListener('click', () => {
  if (!navigator.geolocation) return alert("Geolocation is not supported by your browser.");
  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      L.marker([lat, lng]).addTo(map).bindPopup("You are here!").openPopup();
      map.setView([lat, lng], 10);
    },
    err => alert("Error getting location: " + err.message)
  );
});

map.on('zoomend', updateLabelSizes);
updateLabelSizes();
</script>
</body>
</html>
