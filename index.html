<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>US Lifestyle Clubs Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  html, body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
  body { display: flex; flex-direction: column; }
  #searchForm {
    flex: 0 0 auto;
    padding: 10px;
    background: #f8f8f8;
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
  }
  #searchForm input { padding: 5px; margin-right: 5px; }
  #map { flex: 1 1 auto; width: 100%; }
  .leaflet-control-reset {
    background: white;
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 4px;
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
    font-size: 16px;
    text-align: center;
    margin-bottom: 6px;
  }
  .club-label {
    background: rgba(255,255,255,0.8);
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    color: #333;
    font-size: 13px;
    box-shadow: 0 0 2px rgba(0,0,0,0.4);
  }
  .state-label {
    font-weight: bold;
    font-size: 14px;
    color: #333;
    background: none;      /* Removed background */
    padding: 0;            /* Removed padding */
    border-radius: 0;      /* Removed border radius */
    text-align: center;
    box-shadow: none;      /* Removed shadow */
  }
</style>
</head>
<body>

<div id="searchForm">
  <input type="text" id="zipInput" placeholder="Enter ZIP code">
  <input type="number" id="radiusInput" placeholder="Radius (miles)" min="1" value="50">
  <button id="searchBtn">Search Nearby Clubs</button>
  <button id="geoBtn">Use My Location</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const defaultCenter = [37.8, -96];
const defaultZoom = 4;

// Disable default zoom control to prevent duplicates
const map = L.map('map', { minZoom: 3, maxZoom: 18, zoomControl: false }).setView(defaultCenter, defaultZoom);

// Base map: Carto Voyager No Labels
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.carto.com/">CARTO</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

// Reset View Button
const ResetControl = L.Control.extend({
  options: { position: 'topleft' },
  onAdd: function(map) {
    const container = L.DomUtil.create('div', 'leaflet-control-reset');
    container.innerHTML = 'Reset View';
    L.DomEvent.on(container, 'click', e => {
      L.DomEvent.stopPropagation(e);
      map.setView(defaultCenter, defaultZoom);
    });
    return container;
  }
});
map.addControl(new ResetControl());

// Single zoom control (top-left)
L.control.zoom({ position: 'topleft' }).addTo(map);

let clubsByState = {};
let geojsonLayer;
let clubMarkers = [];

// Load clubs.json and US states GeoJSON
Promise.all([
  fetch("clubs.json").then(r => r.json()),
  fetch("https://rawcdn.githack.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json").then(r => r.json())
]).then(([clubs, statesData]) => {
  clubsByState = clubs;
  geojsonLayer = L.geoJson(statesData, { style, onEachFeature }).addTo(map);
  addStateLabels(geojsonLayer);
}).catch(err => console.error(err));

// Style and highlight functions
function style(feature) {
  return { fillColor: "#66c2a5", weight: 2, opacity: 1, color: "white", dashArray: "3", fillOpacity: 0.7 };
}
function highlightFeature(e) {
  const layer = e.target;
  layer.setStyle({ weight: 3, color: "#666", dashArray: "", fillOpacity: 0.9 });
  layer.bringToFront();
}
function resetHighlight(e) {
  geojsonLayer.resetStyle(e.target);
}
function onEachFeature(feature, layer) {
  const stateName = feature.properties.name === 'District of Columbia' ? 'DC' : feature.properties.name;
  const clubs = clubsByState[stateName] || [];
  let popupContent = `<b>${stateName}</b><br/>`;
  if (clubs.length === 0) popupContent += "No clubs listed yet";
  else clubs.forEach(club => {
    popupContent += club.url ? `<a href="${club.url}" target="_blank">${club.name}</a><br/>` : `${club.name}<br/>`;
  });
  layer.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: () => layer.bindPopup(popupContent).openPopup() });
}

// Add state labels at centroids, properly centered
function addStateLabels(layerGroup) {
  layerGroup.eachLayer(layer => {
    const bounds = layer.getBounds();
    const center = bounds.getCenter();
    const stateName = layer.feature.properties.name === 'District of Columbia' ? 'DC' : layer.feature.properties.name;
    L.marker(center, {
      icon: L.divIcon({
        className: 'state-label',
        html: stateName,
        iconSize: [0, 0],   // size irrelevant for text-only marker
        iconAnchor: [0, 0]
      })
    }).addTo(map);
  });
}
</script>
</body>
</html>
