<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>US Lifestyle Clubs Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
    .state-label {
      font-weight: bold;
      color: black;
      text-shadow: 1px 1px 2px white;
      pointer-events: none;
      white-space: nowrap;
    }
    .leaflet-control-reset {
      background: white;
      padding: 5px 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.3);
      cursor: pointer;
      font-size: 14px;
    }
    .leaflet-control-reset:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    const isMobile = window.matchMedia("(max-width: 768px)").matches;
    const defaultCenter = [39.8283, -98.5795];
    const defaultZoom = isMobile ? 3 : 4;
    
    const map = L.map('map', {
        minZoom: 3,
        maxZoom: 18,
        zoomControl: false,
        attributionControl: false
    }).setView(defaultCenter, defaultZoom);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);
    
    const ResetControl = L.Control.extend({
        options: { position: 'topleft' },
        onAdd: function(map) {
            const container = L.DomUtil.create('div', 'leaflet-control-reset');
            container.innerHTML = 'Reset View';
            L.DomEvent.on(container, 'click', e => {
                L.DomEvent.stopPropagation(e);
                map.setView(defaultCenter, defaultZoom);
                updateLabelSizes();
            });
            return container;
        }
    });
    map.addControl(new ResetControl());
    L.control.zoom({ position: 'topleft' }).addTo(map);
    
    let clubsByState = {};
    let geojsonLayer;
    let stateLabels = {};

    // Example centroids (fill with real data for all states)
    const stateCentroids = {
        "California": [37.5, -119.5],
        "Texas": [31, -99],
        "Florida": [27.8, -81.7],
        "New York": [42.9, -75.5],
        "D.C.": [38.9, -77.0]
    };

    const stateAreas = {
        "California": 163696,
        "Texas": 268596,
        "Florida": 65758,
        "New York": 54555,
        "D.C.": 68
    };

    const labelAdjustments = {
        "D.C.": [0, 0]
    };

    const sampleClubsData = [
        { "name": "Club Cali", "state": "California" },
        { "name": "Texas Nights", "state": "Texas" },
        { "name": "Miami Heat", "state": "Florida" },
        { "name": "NYC After Dark", "state": "New York" },
        { "name": "Capitol Club", "state": "D.C." }
    ];

    sampleClubsData.forEach(club => {
        const state = club.state === "District of Columbia" ? "D.C." : club.state;
        if (!clubsByState[state]) clubsByState[state] = [];
        clubsByState[state].push(club);
    });

    fetch("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json")
        .then(res => res.json())
        .then(us => {
            const states = topojson.feature(us, us.objects.states);
            geojsonLayer = L.geoJSON(states, {
                style: feature => {
                    const origName = feature.properties.name;
                    const stateName = origName === "District of Columbia" ? "D.C." : origName;
                    return {
                        fillColor: clubsByState[stateName] ? "#ff7f50" : "#e0e0e0",
                        weight: 1,
                        color: "white",
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: (feature, layer) => {
                    const origName = feature.properties.name;
                    const stateName = origName === "District of Columbia" ? "D.C." : origName;
                    const clubs = clubsByState[stateName] || [];
                    const popupContent = `<strong>${stateName}</strong><br>` + 
                        (clubs.length ? clubs.map(c => c.name).join("<br>") : "No clubs");
                    layer.bindPopup(popupContent);
                }
            }).addTo(map);

            addStateLabels();
        });

    function addStateLabels() {
        geojsonLayer.eachLayer(layer => {
            const orig = layer.feature.properties.name;
            const stateName = orig === 'District of Columbia' ? 'D.C.' : orig;

            let coords;
            if (stateName === 'D.C.') {
                const c = layer.getBounds().getCenter();
                coords = [c.lat, c.lng];
            } else {
                coords = stateCentroids[stateName];
            }

            const baseAdj = labelAdjustments[stateName] || [0, 0];
            const adj = (stateName === 'D.C.') ? [0, 0] : baseAdj;

            const label = L.marker([coords[0] + adj[0], coords[1] + adj[1]], {
                icon: L.divIcon({
                    className: 'state-label',
                    html: stateName,
                    iconSize: [0, 0],
                    iconAnchor: [0, 0]
                }),
                interactive: false
            }).addTo(map);

            // Force hidden until updateLabelSizes runs
            label.getElement().style.display = 'none';
            stateLabels[stateName] = label;
        });
    }

    function updateLabelSizes() {
        const zoom = map.getZoom();
        const isMobileNow = window.matchMedia("(max-width: 768px)").matches;
        
        Object.entries(stateLabels).forEach(([stateName, label]) => {
            const el = label.getElement();
            
            if (zoom <= (isMobileNow ? 3 : 4)) {
                el.style.display = 'none';
            } else {
                el.style.display = 'block';
                
                const area = stateAreas[stateName] || 25000;
                let baseSize;
                if (zoom === (isMobileNow ? 4 : 5)) baseSize = 10;
                else if (zoom === (isMobileNow ? 5 : 6)) baseSize = 14;
                else if (zoom === (isMobileNow ? 6 : 7)) baseSize = 18;
                else if (zoom === (isMobileNow ? 7 : 8)) baseSize = 22;
                else if (zoom > (isMobileNow ? 7 : 8)) baseSize = 26;
                else baseSize = 10;

                const areaFactor = Math.log(area) / 20;
                let fontSize = baseSize + areaFactor;
                fontSize = Math.max(8, Math.min(30, fontSize));

                if (area < 10000) fontSize = Math.max(8, fontSize - 2);
                if (area < 5000) fontSize = Math.max(8, fontSize - 1);

                el.style.fontSize = `${fontSize}px`;
            }
        });
    }

    map.on('load', updateLabelSizes);
    map.on('zoomend', updateLabelSizes);
</script>
</body>
</html>
