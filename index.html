<!DOCTYPE html> 
<html lang="en"> 
<head> 
<meta charset="UTF-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title>US Lifestyle Clubs Map</title> 
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" /> 
<style>
/* your existing CSS unchanged */
html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { display: flex; flex-direction: column; }
/* ... all existing CSS stays the same ... */
</style> 
</head> 
<body> 
<div id="searchForm">
    <!-- your search form unchanged -->
</div>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const isMobile = window.matchMedia("(max-width: 768px)").matches;
const defaultCenter = [39.8283, -98.5795];
const defaultZoom = isMobile ? 3 : 4;

const map = L.map('map', {
    minZoom: 3,
    maxZoom: 18,
    zoomControl: false,
    attributionControl: false
}).setView(defaultCenter, defaultZoom);

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
    subdomains: 'abcd',
    maxZoom: 19
}).addTo(map);

const ResetControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-control-reset');
        container.innerHTML = 'Reset View';
        L.DomEvent.on(container, 'click', e => {
            L.DomEvent.stopPropagation(e);
            map.setView(defaultCenter, defaultZoom);
        });
        return container;
    }
});
map.addControl(new ResetControl());
L.control.zoom({ position: 'topleft' }).addTo(map);

let clubsByState = {};
let geojsonLayer;
let stateLabels = {};

// State centroids for label placement (unchanged except D.C.)
const stateCentroids = {
    /* ... all your state centroids ... */
    "D.C.": [38.9, -77.0]
};

// Adjusted label positions
const labelAdjustments = {
    /* ... all your adjustments ... */
    "D.C.": [-0.5, -0.5]
};

// Sample clubs fallback including D.C.
const sampleClubsData = {
    "California": [{ name: "San Francisco Club", url: "https://example.com/sf" }, { name: "LA Lifestyle", url: "https://example.com/la" }],
    "New York": [{ name: "NYC Social Club", url: "https://example.com/nyc" }],
    "Texas": [{ name: "Austin Connections", url: "https://example.com/austin" }, { name: "Houston Hub", url: "https://example.com/houston" }],
    "Florida": [{ name: "Miami Nights", url: "https://example.com/miami" }],
    "D.C.": [{ name: "Capital Social Club", url: "https://example.com/dc" }]
};

// Load clubs data
fetch('clubs.json')
    .then(res => { if (!res.ok) throw new Error('Failed'); return res.json(); })
    .then(data => { clubsByState = data; return fetch("https://rawcdn.githack.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json"); })
    .catch(err => { console.error("Error loading clubs.json, using sample data", err); clubsByState = sampleClubsData; return fetch("https://rawcdn.githack.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json"); })
    .then(res => res.json())
    .then(statesData => {
        geojsonLayer = L.geoJson(statesData, { style, onEachFeature }).addTo(map);
        addStateLabels();
        updateLabelSizes();
    })
    .catch(err => console.error("Error loading data:", err));

// ✅ Fixed style: use "D.C." everywhere
function style(feature) {
    const stateName = feature.properties.name === 'District of Columbia' ? 'D.C.' : feature.properties.name;
    const hasClubs = clubsByState[stateName] && clubsByState[stateName].length > 0;
    return {
        fillColor: hasClubs ? "#3498db" : "#bdc3c7",
        weight: 2,
        opacity: 1,
        color: "white",
        dashArray: "3",
        fillOpacity: 0.7
    };
}

function highlightFeature(e) {
    const layer = e.target;
    layer.setStyle({ weight: 3, color: "#666", dashArray: "", fillOpacity: 0.9 });
    layer.bringToFront();

    const stateName = layer.feature.properties.name === 'District of Columbia' ? 'D.C.' : layer.feature.properties.name;
    if (stateLabels[stateName]) stateLabels[stateName].getElement().classList.add('highlight');
}

function resetHighlight(e) {
    geojsonLayer.resetStyle(e.target);

    const stateName = e.target.feature.properties.name === 'District of Columbia' ? 'D.C.' : e.target.feature.properties.name;
    if (stateLabels[stateName]) stateLabels[stateName].getElement().classList.remove('highlight');
}

function onEachFeature(feature, layer) {
    const stateName = feature.properties.name === 'District of Columbia' ? 'D.C.' : feature.properties.name;
    const clubs = clubsByState[stateName] || [];

    let popupContent = `<div class="state-popup-title">${stateName}</div>`;
    if (clubs.length === 0) popupContent += `<div class="no-clubs">No clubs listed yet</div>`;
    else {
        popupContent += `<ul class="club-list">`;
        clubs.forEach(club => {
            popupContent += `<li class="club-item">` + 
                (club.url ? `<a class="club-link" href="${club.url}" target="_blank">${club.name}</a>` : `<span>${club.name}</span>`) + 
                `</li>`;
        });
        popupContent += `</ul>`;
    }

    layer.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: () => layer.bindPopup(popupContent, { maxWidth: 350 }).openPopup() });
}

// ✅ Fixed addStateLabels: use polygon center for D.C.
function addStateLabels() {
    geojsonLayer.eachLayer(layer => {
        const stateName = layer.feature.properties.name === 'District of Columbia' ? 'D.C.' : layer.feature.properties.name;
        let coords = stateCentroids[stateName];
        if (stateName === 'D.C.') coords = layer.getBounds().getCenter(); // center for tiny D.C.
        const adj = labelAdjustments[stateName] || [0, 0];

        const label = L.marker([coords.lat || coords[0] + adj[0], coords.lng || coords[1] + adj[1]], {
            icon: L.divIcon({ className: 'state-label', html: stateName, iconSize: [0, 0], iconAnchor: [0, 0] }),
            interactive: false
        }).addTo(map);

        stateLabels[stateName] = label;
    });
}

// updateLabelSizes function unchanged
function updateLabelSizes() { /* ... same as your code ... */ }

document.getElementById('searchBtn').addEventListener('click', () => { const zipCode = document.getElementById('zipInput').value; if (!zipCode) return alert('Please enter a ZIP code to search.'); alert(`Search functionality for ZIP code ${zipCode} would be implemented here.`); });
document.getElementById('geoBtn').addEventListener('click', () => {
    if (!navigator.geolocation) return alert("Geolocation is not supported by your browser.");
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        L.marker([lat, lng]).addTo(map).bindPopup("You are here!").openPopup();
        map.setView([lat, lng], 10);
    }, err => alert("Error getting location: " + err.message));
});
map.on('zoomend', updateLabelSizes);
updateLabelSizes();
</script> 
</body> 
</html>
