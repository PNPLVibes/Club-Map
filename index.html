<script>
const defaultCenter = [37.8, -96];
const defaultZoom = 5;

const map = L.map('map', { minZoom: 3, maxZoom: 7, zoomControl: false }).setView(defaultCenter, defaultZoom);

// Reset button
const ResetControl = L.Control.extend({
  options: { position: 'topleft' },
  onAdd: function(map) {
    const container = L.DomUtil.create('div', 'leaflet-control-reset');
    container.innerHTML = 'Reset View';
    L.DomEvent.on(container, 'click', function(e) {
      L.DomEvent.stopPropagation(e);
      map.setView(defaultCenter, defaultZoom);
    });
    return container;
  }
});
map.addControl(new ResetControl());

// Zoom control
L.control.zoom({ position: 'topleft' }).addTo(map);

// Tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let clubsByState = {};

// Load GeoJSON and clubs.json together
Promise.all([
  fetch("clubs.json").then(r => r.json()),
  fetch("https://rawcdn.githack.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json").then(r => r.json())
]).then(([clubs, statesData]) => {
  clubsByState = clubs;
  L.geoJson(statesData, { style, onEachFeature }).addTo(map);
}).catch(err => console.error(err));

// Styling
function style(feature) {
  return {
    fillColor: "#66c2a5",
    weight: 2,
    opacity: 1,
    color: "white",
    dashArray: "3",
    fillOpacity: 0.7
  };
}

function highlightFeature(e) {
  const layer = e.target;
  layer.setStyle({ weight: 3, color: "#666", dashArray: "", fillOpacity: 0.9 });
  layer.bringToFront();
}

function resetHighlight(e) {
  geojson.resetStyle(e.target);
}

function onEachFeature(feature, layer) {
  const stateName = feature.properties.name;
  const clubs = clubsByState[stateName] || [];
  let popupContent = `<b>${stateName}</b><br/>`;

  if (clubs.length === 0) {
    popupContent += "No clubs listed yet";
  } else {
    clubs.forEach(club => {
      if (club.url) popupContent += `<a href="${club.url}" target="_blank">${club.name}</a><br/>`;
      else popupContent += `${club.name}<br/>`;
    });
  }

  layer.on({
    mouseover: highlightFeature,
    mouseout: resetHighlight,
    click: () => layer.bindPopup(popupContent).openPopup()
  });
}
</script>
