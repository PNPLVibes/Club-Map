<!DOCTYPE html> 
<html lang="en"> 
<head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>US Lifestyle Clubs Map</title> 
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" /> 
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .state-label {
      color: black;
      font-weight: bold;
      text-shadow: 1px 1px 2px white;
      pointer-events: none;
      white-space: nowrap;
    }
    .state-label.highlight {
      color: red;
    }
    .leaflet-popup-content {
      font-size: 14px;
    }
    .state-popup-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .club-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .club-item {
      margin: 4px 0;
    }
    .club-link {
      color: #3498db;
      text-decoration: none;
    }
    .club-link:hover {
      text-decoration: underline;
    }
    .no-clubs {
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([37.8, -96], 4);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    let geojsonLayer;
    let clubsByState = {};
    const stateLabels = {};

    // Example fallback data
    const sampleClubsData = {
      "California": [
        { name: "Club X", url: "https://clubx.com" },
        { name: "Club Y" }
      ],
      "Texas": [
        { name: "Lone Star Lifestyle", url: "https://lonestar.com" }
      ],
      "D.C.": [
        { name: "Capital Club", url: "https://capitalclub.com" }
      ]
    };

    const stateAreas = {
      "California": 423967, "Texas": 695662, "D.C.": 177
    };

    const stateCentroids = {
      "California": [37.5, -119.5],
      "Texas": [31, -99],
      "D.C.": [38.9, -77.04]
    };

    const labelAdjustments = {
      "California": [0, 0],
      "Texas": [0, 0],
      "D.C.": [0, 0]
    };

    fetch("clubs.json")
      .then(res => {
        if (!res.ok) throw new Error('Failed to load clubs.json');
        return res.json();
      })
      .then(data => {
        clubsByState = data;
        return fetch("https://rawcdn.githack.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json");
      })
      .catch(err => {
        console.error("Error loading clubs.json, using sample data", err);
        clubsByState = sampleClubsData;
        return fetch("https://rawcdn.githack.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json");
      })
      .then(res => res.json())
      .then(statesData => {
        geojsonLayer = L.geoJson(statesData, { style, onEachFeature }).addTo(map);
        addStateLabels();
        updateLabelSizes(); // first update
      })
      .catch(err => console.error("Error loading data:", err));

    function style(feature) {
      const stateName = feature.properties.name === 'District of Columbia' ? 'D.C.' : feature.properties.name;
      const hasClubs = clubsByState[stateName] && clubsByState[stateName].length > 0;
      return {
        fillColor: hasClubs ? "#3498db" : "#bdc3c7",
        weight: 2,
        opacity: 1,
        color: "white",
        dashArray: "3",
        fillOpacity: 0.7
      };
    }

    function highlightFeature(e) {
      const layer = e.target;
      layer.setStyle({
        weight: 3,
        color: "#666",
        dashArray: "",
        fillOpacity: 0.9
      });
      layer.bringToFront();

      const stateName = layer.feature.properties.name === 'District of Columbia' ? 'D.C.' : layer.feature.properties.name;
      if (stateLabels[stateName]) stateLabels[stateName].getElement().classList.add('highlight');
    }

    function resetHighlight(e) {
      geojsonLayer.resetStyle(e.target);
      const stateName = e.target.feature.properties.name === 'District of Columbia' ? 'D.C.' : e.target.feature.properties.name;
      if (stateLabels[stateName]) stateLabels[stateName].getElement().classList.remove('highlight');
    }

    function onEachFeature(feature, layer) {
      const stateName = feature.properties.name === 'District of Columbia' ? 'D.C.' : feature.properties.name;
      const clubs = clubsByState[stateName] || [];

      let popupContent = `<div class="state-popup-title">${stateName}</div>`;
      if (clubs.length === 0) {
        popupContent += `<div class="no-clubs">No clubs listed yet</div>`;
      } else {
        popupContent += `<ul class="club-list">`;
        clubs.forEach(club => {
          popupContent += `<li class="club-item">`;
          popupContent += club.url ? 
            `<a class="club-link" href="${club.url}" target="_blank">${club.name}</a>` : 
            `<span>${club.name}</span>`;
          popupContent += `</li>`;
        });
        popupContent += `</ul>`;
      }

      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: () => layer.bindPopup(popupContent, { maxWidth: 350 }).openPopup()
      });
    }

    function addStateLabels() {
      geojsonLayer.eachLayer(layer => {
        const orig = layer.feature.properties.name;
        const stateName = orig === 'District of Columbia' ? 'D.C.' : orig;

        let coords;
        if (stateName === 'D.C.') {
          coords = layer.getBounds().getCenter();
        } else {
          coords = stateCentroids[stateName];
        }

        const baseAdj = labelAdjustments[stateName] || [0, 0];
        const adj = (stateName === 'D.C.') ? [0, 0] : baseAdj;

        const label = L.marker([coords[0] + adj[0], coords[1] + adj[1]], {
          icon: L.divIcon({
            className: 'state-label',
            html: stateName,
            iconSize: [0, 0],
            iconAnchor: [0, 0]
          }),
          interactive: false
        }).addTo(map);

        stateLabels[stateName] = label;
      });
    }

    function updateLabelSizes() {
      const zoom = map.getZoom();
      const isMobileNow = window.matchMedia("(max-width: 768px)").matches;

      Object.entries(stateLabels).forEach(([stateName, label]) => {
        const el = label.getElement();

        // Hide when zoomed out
        if (zoom <= (isMobileNow ? 3 : 4)) {
          el.style.display = 'none';
          return;
        }

        // Show when zoomed in
        el.style.display = 'block';

        // Font scaling by area
        const area = stateAreas[stateName] || 25000;
        let baseSize;
        if (zoom === (isMobileNow ? 4 : 5)) baseSize = 10;
        else if (zoom === (isMobileNow ? 5 : 6)) baseSize = 14;
        else if (zoom === (isMobileNow ? 6 : 7)) baseSize = 18;
        else if (zoom === (isMobileNow ? 7 : 8)) baseSize = 22;
        else if (zoom > (isMobileNow ? 7 : 8)) baseSize = 26;
        else baseSize = 10;

        const areaFactor = Math.log(area) / 20;
        let fontSize = baseSize + areaFactor;

        fontSize = Math.max(8, Math.min(30, fontSize));
        if (area < 10000) fontSize = Math.max(8, fontSize - 2);
        if (area < 5000) fontSize = Math.max(8, fontSize - 1);

        el.style.fontSize = `${fontSize}px`;
      });
    }

    map.on('zoomend', updateLabelSizes);
  </script> 
</body> 
</html>
