<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>US Lifestyle Clubs & Dungeons Map</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
* {
    box-sizing: border-box;
}

html, body { 
    height: 100%; 
    margin: 0; 
    padding: 0; 
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

body { 
    display: flex; 
    flex-direction: column; 
}

#searchForm {
    flex: 0 0 auto;
    padding: 12px 16px;
    background: rgba(44, 62, 80, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border-bottom: 2px solid rgba(52, 152, 219, 0.3);
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    justify-content: center;
    position: relative;
}

#searchForm::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #e74c3c, #f39c12, #f1c40f, #2ecc71, #3498db, #9b59b6);
    background-size: 400% 400%;
    animation: gradientShift 8s ease infinite;
}

@keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.input-group { 
    display: flex; 
    gap: 8px; 
    align-items: center; 
}

.radio-group {
    gap: 4px;
}

#searchForm input { 
    padding: 10px 12px; 
    border: 2px solid rgba(52, 152, 219, 0.3); 
    border-radius: 10px; 
    font-size: 15px; 
    min-width: 160px;
    background: rgba(255, 255, 255, 0.95);
    transition: all 0.3s ease;
    font-family: 'Inter', sans-serif;
    font-weight: 500;
}

#searchForm input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    background: rgba(255, 255, 255, 1);
    transform: translateY(-1px);
}

#radiusInput { 
    width: 100px; 
}

#searchForm button { 
    padding: 10px 18px; 
    background: linear-gradient(135deg, #3498db, #2980b9); 
    color: white; 
    border: none; 
    border-radius: 10px; 
    cursor: pointer; 
    transition: all 0.3s ease; 
    font-size: 14px; 
    font-weight: 600; 
    font-family: 'Inter', sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
}

#searchForm button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.6s;
}

#searchForm button:hover::before {
    left: 100%;
}

#searchForm button:hover { 
    background: linear-gradient(135deg, #2980b9, #1f4e79);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
}

#searchForm button:active {
    transform: translateY(0);
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
}

#searchForm button:disabled { 
    background: linear-gradient(135deg, #95a5a6, #7f8c8d); 
    cursor: not-allowed; 
    transform: none;
    box-shadow: none;
}

#searchForm button#geoBtn { 
    background: linear-gradient(135deg, #27ae60, #229954); 
}

#searchForm button#geoBtn:hover { 
    background: linear-gradient(135deg, #229954, #1e7e34);
    box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
}

#searchForm button#resetBtn { 
    background: linear-gradient(135deg, #e74c3c, #c0392b); 
}

#searchForm button#resetBtn:hover { 
    background: linear-gradient(135deg, #c0392b, #a93226);
    box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
}

#searchForm label { 
    color: white; 
    font-size: 13px; 
    font-weight: 500;
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 6px;
    transition: all 0.3s ease;
    user-select: none;
}

#searchForm label:hover {
    background: rgba(255, 255, 255, 0.1);
}

#searchForm input[type="radio"] { 
    margin-right: 8px; 
    accent-color: #3498db;
    transform: scale(1.2);
}

#map { 
    flex: 1 1 auto; 
    width: 100%;
    border-radius: 0;
    position: relative;
}

.loading { 
    opacity: 0.7; 
}

.error-message { 
    color: #e74c3c; 
    background: rgba(231, 76, 60, 0.15); 
    padding: 12px 16px; 
    border-radius: 8px; 
    margin: 8px 0; 
    border-left: 4px solid #e74c3c;
    font-weight: 500;
    animation: slideInUp 0.3s ease;
}

.success-message { 
    color: #27ae60; 
    background: rgba(39, 174, 96, 0.15); 
    padding: 12px 16px; 
    border-radius: 8px; 
    margin: 8px 0; 
    border-left: 4px solid #27ae60;
    font-weight: 500;
    animation: slideInUp 0.3s ease;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.leaflet-control-reset {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 12px 18px;
    cursor: pointer;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    font-size: 16px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 12px;
    border: 2px solid rgba(52, 152, 219, 0.2);
    transition: all 0.3s ease;
    font-family: 'Inter', sans-serif;
}

.leaflet-control-reset:hover { 
    background: rgba(52, 152, 219, 0.1);
    border-color: #3498db;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.2);
}

.state-label {
    font-weight: 700;
    color: #2c3e50;
    text-shadow: 2px 2px 4px rgba(255,255,255,0.8), -1px -1px 2px rgba(255,255,255,0.8);
    pointer-events: none;
    text-align: center;
    white-space: nowrap;
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: font-size 0.4s ease, color 0.3s ease;
    font-family: 'Inter', sans-serif;
    letter-spacing: 0.5px;
}

.state-label.hidden { 
    display: none; 
}

.state-label.highlight { 
    color: #e74c3c; 
    font-weight: 800;
    text-shadow: 2px 2px 8px rgba(231, 76, 60, 0.3);
}

.leaflet-popup-content-wrapper { 
    border-radius: 16px; 
    padding: 4px; 
    background: rgba(248, 249, 250, 0.98); 
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); 
    border: 1px solid rgba(52, 152, 219, 0.2);
}

.leaflet-popup-content { 
    margin: 20px; 
    font-size: 16px; 
    line-height: 1.6; 
    min-width: 280px; 
    font-family: 'Inter', sans-serif;
}

.state-popup-title { 
    font-size: 24px; 
    font-weight: 700; 
    color: #2c3e50; 
    margin-bottom: 16px; 
    padding-bottom: 12px; 
    border-bottom: 3px solid #3498db; 
    text-align: center;
    background: linear-gradient(135deg, #3498db, #9b59b6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 0.5px;
}

.club-list-container { 
    max-height: 240px; 
    overflow-y: auto; 
    border: 2px solid rgba(52, 152, 219, 0.1); 
    border-radius: 12px; 
    background: rgba(255, 255, 255, 0.8); 
    padding: 8px;
    backdrop-filter: blur(5px);
}

.club-list-container::-webkit-scrollbar {
    width: 8px;
}

.club-list-container::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.1);
    border-radius: 4px;
}

.club-list-container::-webkit-scrollbar-thumb {
    background: rgba(52, 152, 219, 0.3);
    border-radius: 4px;
}

.club-list-container::-webkit-scrollbar-thumb:hover {
    background: rgba(52, 152, 219, 0.5);
}

.club-list { 
    list-style-type: none; 
    padding: 0; 
    margin: 0; 
}

.club-item { 
    padding: 14px 0; 
    border-bottom: 1px solid rgba(52, 152, 219, 0.1);
    transition: all 0.3s ease;
}

.club-item:last-child { 
    border-bottom: none; 
}

.club-item:hover {
    background: rgba(52, 152, 219, 0.05);
    border-radius: 8px;
    padding-left: 8px;
    padding-right: 8px;
}

.club-name { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 6px; 
}

.club-link { 
    color: #2980b9; 
    text-decoration: none; 
    font-weight: 600; 
    padding: 8px 12px; 
    border-radius: 8px; 
    transition: all 0.3s ease; 
    flex: 1;
    font-family: 'Inter', sans-serif;
}

.club-link:hover { 
    background: rgba(52, 152, 219, 0.1); 
    color: #e74c3c;
    transform: translateX(4px);
}

.club-location { 
    font-size: 13px; 
    color: #7f8c8d; 
    margin-left: 12px; 
    font-style: italic;
    font-weight: 500;
}

.club-type { 
    font-size: 11px; 
    background: linear-gradient(135deg, #f39c12, #e67e22); 
    color: white; 
    padding: 4px 8px; 
    border-radius: 6px; 
    margin-left: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.club-type.dungeon { 
    background: linear-gradient(135deg, #34495e, #2c3e50); 
    color: #ff6b6b;
}

.no-clubs { 
    font-style: italic; 
    color: #7f8c8d; 
    text-align: center; 
    padding: 20px 0; 
    font-size: 16px;
    font-weight: 500;
}

.leaflet-control-attribution { 
    display: none !important; 
}

/* Custom marker styles */
.zip-marker, .user-location-marker {
    font-size: 20px;
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}

@media (max-width: 768px) {
    #searchForm { 
        flex-direction: column; 
        align-items: stretch; 
        padding: 10px 12px; 
        gap: 8px; 
    }
    
    .input-group { 
        width: 100%; 
        flex-direction: row; 
        gap: 10px; 
    }
    
    #searchForm input { 
        min-width: auto; 
        padding: 12px 14px; 
        font-size: 14px; 
        flex: 1; 
    }
    
    #zipInput { 
        flex: 2; 
    }
    
    #radiusInput { 
        width: 80px; 
        flex: none; 
    }
    
    .button-group { 
        display: flex; 
        width: 100%; 
        gap: 8px; 
    }
    
    #searchForm button { 
        padding: 12px 16px; 
        font-size: 13px; 
        flex: 1;
        letter-spacing: 0.3px;
    }
    
    .state-label { 
        font-size: 10px; 
    }
    
    .leaflet-popup-content { 
        font-size: 14px; 
        min-width: 240px; 
        margin: 16px;
    }
    
    .state-popup-title { 
        font-size: 20px; 
    }
    
    .club-name { 
        flex-direction: row; 
        align-items: center; 
        justify-content: space-between; 
    }
    
    .club-type { 
        margin-left: 8px; 
        margin-top: 0; 
    }
    
    .club-location { 
        margin-left: 0; 
        margin-top: 4px; 
    }
}

/* Enhanced focus states for accessibility */
#searchForm input:focus,
#searchForm button:focus,
#searchForm label:focus-within {
    outline: 2px solid #3498db;
    outline-offset: 2px;
}

/* Loading animation enhancement */
.loading {
    position: relative;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
</head>
<body>
<div id="searchForm">
    <div class="input-group">
        <input type="text" id="zipInput" placeholder="Enter ZIP code" maxlength="5" pattern="[0-9]{5}">
        <input type="number" id="radiusInput" placeholder="Miles" min="1" max="500" value="50" title="Search radius in miles">
    </div>
    <div class="button-group">
        <button id="searchBtn">Search Nearby</button>
        <button id="geoBtn">Use My Location</button>
        <button id="resetBtn">Reset Search</button>
    </div>
    <div class="input-group radio-group">
        <label><input type="radio" name="filterType" value="all" checked> Clubs & Dungeons</label>
        <label><input type="radio" name="filterType" value="clubs"> Just Clubs</label>
        <label><input type="radio" name="filterType" value="dungeons"> Just Dungeons</label>
    </div>
    <div id="statusMessage"></div>
</div>
<div id="map"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
// Check if Leaflet loaded properly
if (typeof L === 'undefined') {
    document.getElementById('statusMessage').innerHTML = '<div class="error-message">Map library failed to load. Please refresh the page or check your internet connection.</div>';
    throw new Error('Leaflet library not loaded');
}

const isMobile = window.matchMedia("(max-width: 768px)").matches;
const defaultCenter = [39.8283, -98.5795];
const defaultZoom = isMobile ? 3 : 4;

const map = L.map('map', { minZoom: 3, maxZoom: 18, zoomControl: false, attributionControl: false }).setView(defaultCenter, defaultZoom);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 19 }).addTo(map);

const ResetControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-control-reset');
        container.innerHTML = 'Reset View';
        L.DomEvent.on(container, 'click', e => { L.DomEvent.stopPropagation(e); resetSearch(); });
        return container;
    }
});
map.addControl(new ResetControl());
L.control.zoom({ position: 'topleft' }).addTo(map);

let clubsByState = {};
let dungeonsByState = {};
let geojsonLayer;
let stateLabels = {};
let currentFilter = 'all';
let searchMarkers = [];
let userLocationMarker = null;

// Utility functions
function showMessage(message, type = 'info') {
    const statusEl = document.getElementById('statusMessage');
    statusEl.innerHTML = `<div class="${type}-message">${message}</div>`;
    setTimeout(() => statusEl.innerHTML = '', 5000);
}

function validateZipCode(zip) {
    const zipPattern = /^\d{5}$/;
    return zipPattern.test(zip);
}

function setButtonLoading(buttonId, isLoading) {
    const button = document.getElementById(buttonId);
    button.disabled = isLoading;
    if (isLoading) {
        button.dataset.originalText = button.textContent;
        button.textContent = 'Loading...';
        button.classList.add('loading');
    } else {
        button.textContent = button.dataset.originalText || button.textContent;
        button.classList.remove('loading');
    }
}

// Distance calculation functions
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 3959; // Earth's radius in miles
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function toRad(degrees) {
    return degrees * (Math.PI/180);
}

// ZIP code coordinate lookup with better error handling
async function getZipCoordinates(zipCode) {
    try {
        // Use HTTPS to avoid mixed content issues
        const response = await fetch(`https://api.zippopotam.us/us/${zipCode}`);
        if (!response.ok) {
            throw new Error(response.status === 404 ? 'ZIP code not found' : `API error: ${response.status}`);
        }
        const data = await response.json();
        
        if (!data.places || data.places.length === 0) {
            throw new Error('No location data found for this ZIP code');
        }
        
        return {
            lat: parseFloat(data.places[0].latitude),
            lng: parseFloat(data.places[0].longitude),
            city: data.places[0]['place name'],
            state: data.places[0]['state abbreviation']
        };
    } catch (error) {
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            throw new Error('Network error - please check your internet connection');
        }
        throw error;
    }
}

// Reset search function
function resetSearch() {
    searchMarkers.forEach(marker => map.removeLayer(marker));
    searchMarkers = [];
    if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
        userLocationMarker = null;
    }
    
    // Reset form inputs
    document.getElementById('zipInput').value = '';
    document.getElementById('radiusInput').value = '50';
    
    map.setView(defaultCenter, defaultZoom);
    updateLabelSizes();
    showMessage('Search reset', 'success');
}

// Improved search results display
function displaySearchResults(venues, zipCoords, radius, zipCode) {
    // Clear previous search markers
    searchMarkers.forEach(marker => map.removeLayer(marker));
    searchMarkers = [];

    // Add ZIP code marker with better popup
    const zipMarker = L.marker([zipCoords.lat, zipCoords.lng], {
        icon: L.divIcon({
            className: 'zip-marker',
            html: '📍',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        })
    }).bindPopup(`
        <strong>Search Center</strong><br>
        ${zipCode}<br>
        ${zipCoords.city}, ${zipCoords.state}<br>
        Radius: ${radius} miles
    `).addTo(map);
    searchMarkers.push(zipMarker);

    // Add radius circle
    const radiusCircle = L.circle([zipCoords.lat, zipCoords.lng], {
        radius: radius * 1609.34, // Convert miles to meters
        fillColor: '#f8f9fa',
        fillOpacity: 0.3,
        color: '#dee2e6',
        weight: 2
    }).addTo(map);
    searchMarkers.push(radiusCircle);

    // Group venues by location to handle multiple venues at same location
    const locationGroups = {};
    venues.forEach(venue => {
        const key = `${venue.lat},${venue.lng}`;
        if (!locationGroups[key]) {
            locationGroups[key] = [];
        }
        locationGroups[key].push(venue);
    });

    // Add markers for each location group
    Object.values(locationGroups).forEach(venueGroup => {
        const firstVenue = venueGroup[0];
        let popupContent = '';
        
        if (venueGroup.length === 1) {
            const venue = venueGroup[0];
            const location = (venue.city && venue.state) ? `${venue.city}, ${venue.state}` : (venue.state || '');
            popupContent = `
                <div class="state-popup-title">Search Result</div>
                <div class="club-list-container">
                    <ul class="club-list">
                        <li class="club-item">
                            <div class="club-name">
                                <a class="club-link" href="${venue.url||'#'}" target="_blank" rel="noopener">${venue.name}</a>
                                <span class="club-type ${venue.type}">${venue.type}</span>
                            </div>
                            ${location ? `<div class="club-location">${location}</div>` : ''}
                            <div class="club-location">Distance: ${venue.distance.toFixed(1)} miles</div>
                        </li>
                    </ul>
                </div>
            `;
        } else {
            popupContent = `
                <div class="state-popup-title">Search Results (${venueGroup.length} venues)</div>
                <div class="club-list-container">
                    <ul class="club-list">
            `;
            venueGroup.forEach(venue => {
                const location = (venue.city && venue.state) ? `${venue.city}, ${venue.state}` : (venue.state || '');
                popupContent += `
                    <li class="club-item">
                        <div class="club-name">
                            <a class="club-link" href="${venue.url||'#'}" target="_blank" rel="noopener">${venue.name}</a>
                            <span class="club-type ${venue.type}">${venue.type}</span>
                        </div>
                        ${location ? `<div class="club-location">${location}</div>` : ''}
                    </li>
                `;
            });
            popupContent += `
                    </ul>
                    <div style="text-align: center; margin-top: 10px; font-style: italic; color: #7f8c8d;">
                        Distance: ${firstVenue.distance.toFixed(1)} miles
                    </div>
                </div>
            `;
        }

        const marker = L.marker([firstVenue.lat, firstVenue.lng])
            .bindPopup(popupContent, { maxWidth: 300 })
            .addTo(map);
        searchMarkers.push(marker);
    });

    // Fit map to show all results with padding
    if (venues.length > 0) {
        const group = new L.featureGroup(searchMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
        showMessage(`Found ${venues.length} venue${venues.length !== 1 ? 's' : ''} within ${radius} miles`, 'success');
    } else {
        map.setView([zipCoords.lat, zipCoords.lng], 10);
        showMessage(`No venues found within ${radius} miles of ${zipCode}`, 'error');
    }
}

// Load data with better error handling
Promise.all([
    fetch('clubs_geocoded.json').then(res => {
        if (!res.ok) throw new Error('Failed to load clubs data');
        return res.json();
    }).catch(() => {
        showMessage('Warning: Could not load clubs data', 'error');
        return {};
    }),
    fetch('dungeons_geocoded.json').then(res => {
        if (!res.ok) throw new Error('Failed to load dungeons data');
        return res.json();
    }).catch(() => {
        showMessage('Warning: Could not load dungeons data', 'error');
        return {};
    })
]).then(([clubsData, dungeonsData]) => {
    clubsByState = clubsData;
    dungeonsByState = dungeonsData;
    return fetch("https://rawcdn.githack.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json");
}).then(res => {
    if (!res.ok) throw new Error('Failed to load map data');
    return res.json();
}).then(statesData => {
    geojsonLayer = L.geoJson(statesData, { style, onEachFeature }).addTo(map);
    addStateLabels();
    updateLabelSizes();
    showMessage('Map loaded successfully', 'success');
}).catch(err => {
    console.error("Error loading data:", err);
    showMessage('Error loading map data. Please refresh the page.', 'error');
});

function style(feature) {
    const stateName = feature.properties.name;
    const hasClubs = clubsByState[stateName] && clubsByState[stateName].length > 0;
    const hasDungeons = dungeonsByState[stateName] && dungeonsByState[stateName].length > 0;
    let fillColor = "#bdc3c7";
    if (currentFilter === 'all' && (hasClubs || hasDungeons)) fillColor = "#3498db";
    else if (currentFilter === 'clubs' && hasClubs) fillColor = "#3498db";
    else if (currentFilter === 'dungeons' && hasDungeons) fillColor = "#3498db";
    return { fillColor, weight: 2, opacity: 1, color: "white", dashArray: "3", fillOpacity: 0.7 };
}

function highlightFeature(e) {
    const layer = e.target;
    layer.setStyle({ weight: 3, color: "#666", dashArray: "", fillOpacity: 0.9 });
    layer.bringToFront();
    const stateName = layer.feature.properties.name;
    if (stateLabels[stateName]) stateLabels[stateName].getElement().classList.add('highlight');
}

function resetHighlight(e) {
    geojsonLayer.resetStyle(e.target);
    const stateName = e.target.feature.properties.name;
    if (stateLabels[stateName]) stateLabels[stateName].getElement().classList.remove('highlight');
}

function onEachFeature(feature, layer) {
    const stateName = feature.properties.name;
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: () => layer.bindPopup(generatePopup(stateName), { maxWidth: 350 }).openPopup()
    });
}

function generatePopup(stateName) {
    const clubs = clubsByState[stateName] || [];
    const dungeons = dungeonsByState[stateName] || [];
    let popupContent = `<div class="state-popup-title">${stateName}</div>`;

    if ((currentFilter === 'clubs' && clubs.length === 0) ||
        (currentFilter === 'dungeons' && dungeons.length === 0) ||
        (currentFilter === 'all' && clubs.length === 0 && dungeons.length === 0)) {
        popupContent += `<div class="no-clubs">No listings</div>`;
    } else {
        popupContent += `<div class="club-list-container"><ul class="club-list">`;
        if (currentFilter !== 'dungeons') {
            clubs.forEach(c => {
                const location = (c.city && c.state) ? `${c.city}, ${c.state}` : (c.state || '');
                popupContent += `
                    <li class="club-item">
                        <div class="club-name">
                            <a class="club-link" href="${c.url||'#'}" target="_blank" rel="noopener">${c.name}</a>
                            <span class="club-type">club</span>
                        </div>
                        ${location ? `<div class="club-location">${location}</div>` : ''}
                    </li>
                `;
            });
        }
        if (currentFilter !== 'clubs') {
            dungeons.forEach(d => {
                const location = (d.city && d.state) ? `${d.city}, ${d.state}` : (d.state || '');
                popupContent += `
                    <li class="club-item">
                        <div class="club-name">
                            <a class="club-link" href="${d.url||'#'}" target="_blank" rel="noopener">${d.name}</a>
                            <span class="club-type dungeon">dungeon</span>
                        </div>
                        ${location ? `<div class="club-location">${location}</div>` : ''}
                    </li>
                `;
            });
        }
        popupContent += `</ul></div>`;
    }
    return popupContent;
}

function addStateLabels() {
    if (!geojsonLayer) return;
    geojsonLayer.eachLayer(layer => {
        const stateName = layer.feature.properties.name;
        let c = layer.getBounds().getCenter();
        
        // Adjust Idaho's position for better centering
        if (stateName === 'Idaho') {
            c = L.latLng(c.lat - 0.5, c.lng - 0.8);
        }
        
        const label = L.marker([c.lat, c.lng], {
            icon: L.divIcon({ 
                className: 'state-label hidden', 
                html: stateName, 
                iconSize: [0, 0], 
                iconAnchor: [0, 0] 
            }),
            interactive: false
        }).addTo(map);
        stateLabels[stateName] = label;
    });
}

function updateLabelSizes() {
    const zoom = map.getZoom();
    Object.entries(stateLabels).forEach(([stateName, label]) => {
        const el = label.getElement();
        if (!el) return;
        if (zoom <= (isMobile ? 3 : 4)) {
            el.classList.add('hidden');
        } else {
            el.classList.remove('hidden');
            el.style.fontSize = `${Math.max(8, Math.min(24, zoom * 2))}px`;
        }
    });
}

// Event listeners with improved validation
document.querySelectorAll('input[name="filterType"]').forEach(radio => {
    radio.addEventListener('change', e => {
        currentFilter = e.target.value;
        if (geojsonLayer) {
            geojsonLayer.eachLayer(layer => layer.setStyle(style(layer.feature)));
        }
    });
});

document.getElementById('searchBtn').addEventListener('click', async () => {
    const zipCode = document.getElementById('zipInput').value.trim();
    const radius = parseFloat(document.getElementById('radiusInput').value) || 50;
    
    if (!zipCode) {
        showMessage('Please enter a ZIP code to search.', 'error');
        return;
    }
    
    if (!validateZipCode(zipCode)) {
        showMessage('Please enter a valid 5-digit ZIP code.', 'error');
        return;
    }
    
    if (radius < 1 || radius > 500) {
        showMessage('Please enter a radius between 1 and 500 miles.', 'error');
        return;
    }
    
    setButtonLoading('searchBtn', true);
    
    try {
        const zipCoords = await getZipCoordinates(zipCode);
        const nearbyVenues = [];
        
        // Search clubs
        if (currentFilter === 'all' || currentFilter === 'clubs') {
            Object.values(clubsByState).flat().forEach(club => {
                if (club.lat && club.lng) {
                    const distance = calculateDistance(zipCoords.lat, zipCoords.lng, club.lat, club.lng);
                    if (distance <= radius) {
                        nearbyVenues.push({...club, distance, type: 'club'});
                    }
                }
            });
        }
        
        // Search dungeons
        if (currentFilter === 'all' || currentFilter === 'dungeons') {
            Object.values(dungeonsByState).flat().forEach(dungeon => {
                if (dungeon.lat && dungeon.lng) {
                    const distance = calculateDistance(zipCoords.lat, zipCoords.lng, dungeon.lat, dungeon.lng);
                    if (distance <= radius) {
                        nearbyVenues.push({...dungeon, distance, type: 'dungeon'});
                    }
                }
            });
        }
        
        nearbyVenues.sort((a, b) => a.distance - b.distance);
        displaySearchResults(nearbyVenues, zipCoords, radius, zipCode);
        
    } catch (error) {
        showMessage(`Error: ${error.message}`, 'error');
    } finally {
        setButtonLoading('searchBtn', false);
    }
});

document.getElementById('geoBtn').addEventListener('click', () => {
    if (!navigator.geolocation) {
        showMessage("Geolocation is not supported by your browser.", 'error');
        return;
    }
    
    setButtonLoading('geoBtn', true);
    
    navigator.geolocation.getCurrentPosition(
        async pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const radius = parseFloat(document.getElementById('radiusInput').value) || 50;
            
            // Remove previous user location marker
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
            }
            
            userLocationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '📍',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).bindPopup("You are here!").addTo(map);
            
            // Perform search from user location
            const nearbyVenues = [];
            
            // Search clubs
            if (currentFilter === 'all' || currentFilter === 'clubs') {
                Object.values(clubsByState).flat().forEach(club => {
                    if (club.lat && club.lng) {
                        const distance = calculateDistance(lat, lng, club.lat, club.lng);
                        if (distance <= radius) {
                            nearbyVenues.push({...club, distance, type: 'club'});
                        }
                    }
                });
            }
            
            // Search dungeons
            if (currentFilter === 'all' || currentFilter === 'dungeons') {
                Object.values(dungeonsByState).flat().forEach(dungeon => {
                    if (dungeon.lat && dungeon.lng) {
                        const distance = calculateDistance(lat, lng, dungeon.lat, dungeon.lng);
                        if (distance <= radius) {
                            nearbyVenues.push({...dungeon, distance, type: 'dungeon'});
                        }
                    }
                });
            }
            
            nearbyVenues.sort((a, b) => a.distance - b.distance);
            
            // Create coordinates object for display function
            const coords = { lat, lng, city: 'Your Location', state: '' };
            
            displaySearchResults(nearbyVenues, coords, radius, 'Your Location');
            setButtonLoading('geoBtn', false);
        },
        err => {
            let errorMessage = "Error getting location: ";
            switch(err.code) {
                case err.PERMISSION_DENIED:
                    errorMessage += "Permission denied";
                    break;
                case err.POSITION_UNAVAILABLE:
                    errorMessage += "Position unavailable";
                    break;
                case err.TIMEOUT:
                    errorMessage += "Request timeout";
                    break;
                default:
                    errorMessage += "Unknown error";
                    break;
            }
            showMessage(errorMessage, 'error');
            setButtonLoading('geoBtn', false);
        },
        { timeout: 10000, enableHighAccuracy: true }
    );
});

document.getElementById('resetBtn').addEventListener('click', resetSearch);

// Input validation
document.getElementById('zipInput').addEventListener('input', function(e) {
    // Only allow numbers
    this.value = this.value.replace(/\D/g, '');
    // Limit to 5 digits
    if (this.value.length > 5) {
        this.value = this.value.slice(0, 5);
    }
});

// Allow Enter key to trigger search
document.getElementById('zipInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('searchBtn').click();
    }
});

updateLabelSizes();
map.on('zoomend', updateLabelSizes);
</script>
</body>
</html>
