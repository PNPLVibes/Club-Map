<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>US Lifestyle Clubs Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  html, body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
  body { display: flex; flex-direction: column; }

  #searchForm {
    flex: 0 0 auto;
    padding: 10px;
    background: #f8f8f8;
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
  }
  #searchForm input { padding: 5px; margin-right: 5px; }
  #map { flex: 1 1 auto; width: 100%; }

  .leaflet-control-reset {
    background: white;
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 4px;
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
    font-size: 16px;
    text-align: center;
    margin-bottom: 6px;
  }

  .club-label {
    background: rgba(255,255,255,0.8);
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    color: #333;
    font-size: 13px;
    box-shadow: 0 0 2px rgba(0,0,0,0.4);
  }

  /* State labels: remove box and center more accurately */
  .state-label {
    font-weight: bold;
    font-size: 14px;
    color: #333;
    background: none;
    padding: 0;
    border-radius: 0;
    text-align: center;
    box-shadow: none;
  }

  /* Popup styling */
  .custom-popup .popup-content {
    font-size: 16px;       /* Larger text */
    line-height: 1.5;      /* Better spacing */
    color: #333;
  }

  .custom-popup a {
    color: #4c7ef3;
    text-decoration: underline;
  }
</style>
</head>
<body>

<div id="searchForm">
  <input type="text" id="zipInput" placeholder="Enter ZIP code">
  <input type="number" id="radiusInput" placeholder="Radius (miles)" min="1" value="50">
  <button id="searchBtn">Search Nearby Clubs</button>
  <button id="geoBtn">Use My Location</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const defaultCenter = [37.8, -96];
const defaultZoom = 4;

// Disable default zoom control to prevent duplicates
const map = L.map('map', { minZoom: 3, maxZoom: 18, zoomControl: false }).setView(defaultCenter, defaultZoom);

// Base map: Carto Voyager No Labels
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.carto.com/">CARTO</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

// Reset View Button
const ResetControl = L.Control.extend({
  options: { position: 'topleft' },
  onAdd: function(map) {
    const container = L.DomUtil.create('div', 'leaflet-control-reset');
    container.innerHTML = 'Reset View';
    L.DomEvent.on(container, 'click', e => {
      L.DomEvent.stopPropagation(e);
      map.setView(defaultCenter, defaultZoom);
    });
    return container;
  }
});
map.addControl(new ResetControl());

// Single zoom control (top-left)
L.control.zoom({ position: 'topleft' }).addTo(map);

let clubsByState = {};
let geojsonLayer;
let clubMarkers = [];

// Load clubs.json and US states GeoJSON
Promise.all([
  fetch("clubs.json").then(r => r.json()),
  fetch("https://rawcdn.githack.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json").then(r => r.json())
]).then(([clubs, statesData]) => {
  clubsByState = clubs;
  geojsonLayer = L.geoJson(statesData, { style, onEachFeature }).addTo(map);
  addStateLabels();
}).catch(err => console.error(err));

// Style and highlight functions
function style(feature) {
  return { fillColor: "#66c2a5", weight: 2, opacity: 1, color: "white", dashArray: "3", fillOpacity: 0.7 };
}
function highlightFeature(e) {
  const layer = e.target;
  layer.setStyle({ weight: 3, color: "#666", dashArray: "", fillOpacity: 0.9 });
  layer.bringToFront();
}
function resetHighlight(e) {
  geojsonLayer.resetStyle(e.target);
}
function onEachFeature(feature, layer) {
  const stateName = feature.properties.name === 'District of Columbia' ? 'DC' : feature.properties.name;
  const clubs = clubsByState[stateName] || [];
  let popupContent = `<b>${stateName}</b><br/>`;
  if (clubs.length === 0) popupContent += "No clubs listed yet";
  else clubs.forEach(club => {
    popupContent += club.url ? `<a href="${club.url}" target="_blank">${club.name}</a><br/>` : `${club.name}<br/>`;
  });

  layer.on({
    mouseover: highlightFeature,
    mouseout: resetHighlight,
    click: () => {
      layer.bindPopup(`<div class="popup-content">${popupContent}</div>`, {
        maxWidth: 400,
        minWidth: 250,
        className: 'custom-popup'
      }).openPopup();
      map.fitBounds(layer.getBounds(), { padding: [50, 50] });
    }
  });
}

// Add state labels manually for better accuracy
function addStateLabels() {
  const labels = [
    {name: 'WA', coords: [47.5, -120]},
    {name: 'OR', coords: [44, -120]},
    {name: 'CA', coords: [37, -119]},
    {name: 'NV', coords: [39, -117]},
    {name: 'ID', coords: [44.5, -114]},
    {name: 'MT', coords: [46.5, -110]},
    {name: 'WY', coords: [43, -107]},
    {name: 'UT', coords: [39.5, -111.5]},
    {name: 'AZ', coords: [34, -111]},
    {name: 'NM', coords: [34.5, -106]},
    {name: 'CO', coords: [39, -105]},
    {name: 'ND', coords: [47.5, -100]},
    {name: 'SD', coords: [44.5, -100]},
    {name: 'NE', coords: [41.5, -99]},
    {name: 'KS', coords: [38.5, -98]},
    {name: 'OK', coords: [35.5, -97]},
    {name: 'TX', coords: [31, -99]},
    {name: 'MN', coords: [46, -94]},
    {name: 'IA', coords: [42.5, -93]},
    {name: 'MO', coords: [38.5, -92.5]},
    {name: 'AR', coords: [34.7, -92.5]},
    {name: 'LA', coords: [31.5, -92]},
    {name: 'WI', coords: [44.5, -89]},
    {name: 'IL', coords: [40, -89]},
    {name: 'MS', coords: [32.5, -90]},
    {name: 'MI', coords: [44, -84]},
    {name: 'IN', coords: [40, -86]},
    {name: 'OH', coords: [40, -82]},
    {name: 'KY', coords: [37.5, -85.5]},
    {name: 'TN', coords: [36, -86]},
    {name: 'AL', coords: [32.5, -86)],
    {name: 'GA', coords: [33.5, -83]},
    {name: 'FL', coords: [28, -82]},
    {name: 'SC', coords: [33.5, -81]},
    {name: 'NC', coords: [35.5, -79]},
    {name: 'VA', coords: [37.5, -79]},
    {name: 'WV', coords: [38.5, -80]},
    {name: 'PA', coords: [41, -77]},
    {name: 'NY', coords: [43, -75]},
    {name: 'NJ', coords: [40, -74.5]},
    {name: 'DE', coords: [39, -75.5]},
    {name: 'MD', coords: [39, -77]},
    {name: 'DC', coords: [38.9, -77]},
    {name: 'CT', coords: [41.5, -72.7]},
    {name: 'RI', coords: [41.7, -71.5]},
    {name: 'MA', coords: [42.3, -71]},
    {name: 'VT', coords: [43.9, -72.6]},
    {name: 'NH', coords: [43.3, -71.5]},
    {name: 'ME', coords: [45.5, -69.3]}
  ];

  labels.forEach(label => {
    L.marker(label.coords, {
      icon: L.divIcon({
        className: 'state-label',
        html: label.name,
        iconSize: [100, 20],
        iconAnchor: [50, 0]
      })
    }).addTo(map);
  });
}
</script>
</body>
</html>
